<h2>
    Index<br />
</h2>
<ul class="anchor-link list-paddingleft-2">
    <li>
        <p>
            <a href="#step1">前言</a>
        </p>
    </li>
    <li>
        <p>
            &nbsp;&nbsp;&nbsp;&nbsp;<a href="#step2">明确共识</a>
        </p>
    </li>
    <li>
        <p>
            &nbsp;&nbsp;&nbsp;&nbsp;<a href="#step2">引出问题</a>
        </p>
    </li>
    <li>
        <p>
            <a href="#step2">新思路</a>
        </p>
    </li>
    <li>
        <p>
            <a href="#step2">扩大适用范围：plugin</a>
        </p>
    </li>
    <li>
        <p>
            <a href="#step2">前期准备</a>
        </p>
    </li>
    <li>
        <p>
            <a href="#step3">代码范例</a>
        </p>
    </li>
    <li>
        <p>
            <a href="#step4">代码解说</a>
        </p>
    </li>
</ul>
<h2>
    前言
</h2>
<p>
    众所周知，Lookup 是 kintone 中一个比较好用的功能。它可以在填写数据的时候，复制别的 app 的字段值，从而可以避免大块数据重复手动录入的问题。
</p>
<p>
    但是，在日常的运用中，常常有一个需求被广泛提及，那就是 kintone 提供的 Lookup 所复制的数据是固定的，不会随参照源的改变而改变，而有时候，用户就是希望数据会随着改变。这时，所谓的 【Lookup
    自动更新】功能便被提了出来。
</p>
<p>
    其实，已经有不少的开发者成功开发出了【Lookup
    自动更新】功能，有些是专门定制的自定义开发，有些是基于一些泛用插件的功能来实现。但是，通过最近的研究，我们发现这些方法都存在一些问题，在研究就这些问题的过程中，得到了一些开发的经验，于是想在这篇文章中同大家分享。
</p>
<h3>
    明确共识
</h3>
<p>
    在展开讲述之前，我们应该了解【Lookup 自动更新】方面的基础概念。
</p>
<p>
    首先，我们要知道，kintone 默认 提供的 Lookup 功能，没有自动更新，并不是功能上的缺陷，而是最开始功能上就是这么定义的。因为所谓的【Lookup
    自动更新】只是一部分场景的需求，而很多时候，我们就是不希望进行自动更新，自动更新对于这些场景来说是错误的表现。
</p>
<p>
    举例来说，假设现在有两张表，一张商品表，一张订单表，客户买东西时，会生成订单表，订单表里会有客户所选的商品，包括商品名，商品价格等信息。在这种场景下，我们就不能用【Lookup
    自动更新】来更新商品价格，因为订单所反映的是成交时的商品价格，但是商品价格会随时间的变化而变化，不能因为这个变化而影响了之前已经产生过的订单。
</p>
<p>
    那么，另一方面，什么时候我们会需要用到【Lookup 自动更新】功能呢？总的来说，如果用户只关心被参照数据的最新数据，而不想知道历史数据的时候，就会用到【Lookup 自动更新】功能了。
</p>
<p>
    举例来说，也是其他相关文章经常提到的一个案例。
    一张是客户表，是被 Lookup 参照的 app，我们称它为 A。
    另一张是案件表，Lookup 客户表的字段是客户名，需要复制的数据有客户电话，客户地址等。 我们称它为 B。
    当 B 的一条记录生成后，他所参照的客户的电话发生了改变，当再次查看 B 的记录时，希望看到的是最新变化后的电话号码，因为以前的电话号码，用户已经不关心了。
</p>
<h3>
    引出问题
</h3>
<p>
    我研究了市面上能找到的介绍【Lookup 自动更新】功能的各种文章，发现他们都存在一些难以解决的问题。要讲清楚这些问题，先要了解它们基本的设计思路。
</p>
<p>
    就用上面的【客户-案件】案例来说，设计思路是这样的：
<ol>
    <li>
        对 A 表进行自定义。
    </li>
    <li>
        当 A 的记录发生改变时，找到 B 中所有参照 A 这条记录的记录，并更新它们。
    </li>
</ol>
</p>
<p>
    然后，这时候需求增加，有一个叫 C 的 App 也希望能参照 A，于是，开发人员编辑对 A 的自定义，在找参照的地方模仿 B，同样的逻辑， 再更新一遍 C。
</p>
<p>
    现在，有的读者可能已经发现问题了：
</p>
<ol>
    <li>
        如果 A 是一个常用 master 表，例如【员工表】，公司中可能有大量的 App 在 Lookup 它的值。要知道【员工表】可能是人事部门或IT部门在管理的，每当有别的同事制作新 App
        需要参照【员工表】并需要自动更新时，必须通过【员工表】的管理员进行自定义代码的改动，当这种改动变得频繁起来，跨部门的沟通和代码冗长容易造成各种各样的问题。
    </li>
    <li>
        B、C 这样的表一旦改动，或者删除，A 也需要进行相应的改动。繁琐只是一部分问题，更可怕的是，改动 B、C 的人（新接手管理的人）可能根本不知道有【Lookup 自动更新】的功能，因为自定义并不存在于参照方，从 B、C
        这里根本看不出有自定义的痕迹。
    </li>
    <li>
        B、C 这样的表一旦多起来，性能可能也会成为问题。因为改一条 A 的记录，会牵涉到很多记录的查询和更新。
    </li>
</ol>
<p>
    说到这里，产生这种问题的原因也应该呼之欲出了。可以说设计思路一开始就存在缺陷。A 相当于一个内容的发布者，B、C 相当于内容阅读者。如果 A 发布了某个内容的两个版本，那 B、C 需要什么版本不应该由 A
    来分发，而是应该他们自己来订阅。
</p>
<h2>
    新思路
</h2>
<p class="operaCheck">
    为了描述更准确一些，在下文中，我们将 A 类的表叫做【主表】，B、C 类的表叫做【事务表】
</p>
<p>
    根据上文我们已经总结好的问题症结，现在可以拓展新的思路去实现相似的功能效果。大致的设计框架如下：
</p>
<ol>
    <li>
        所有的自定义开发程序，写在【事务表】中，【主表】中不写入任何自定义程序
    </li>
    <li>
        【事务表】中的 Lookup 字段，以及需要复制的字段，即需要表示【主表】相应字段的最新数据的，不做真正的数据更新操作，而只是在有需要显示的时候，才去参照【主表】的内容。
    </li>
</ol>
<h3>
    优缺点
</h3>
<p>
    下面对这种设计框架进行解读：1 带给我们的好处是不必每次都劳烦【主表】的管理员，可谓解决了之前提出的主要问题。但是随之带来的是，【主表】更新的时机，不可能被【事务表】中的程序所探知，于是在 2 中，我们放弃了真正的数据更新，改为在显示时去实时参照【主表】中的内容。这样做的利弊有：
</p>
<ul>
    <li>
        所有数据维持 kintone 默认下的 Lookup 仕样，即数据生成时的原始状态。当我们撤销自定义时，一切都会恢复原状，避免了数据不整合的风险。
    </li>
    <li>
        绝大多数的情况下，都是查看网页上内容时，需要看到【主表】的最新内容，所以即使原始数据不改动，只是实时参照的话，也足够应付。
    </li>
    <li>
        由于原始数据没有真正改动，所以所有的汇总统计都是不会是根据【主表】最新数据所产生的，所以有统计需求的场景，就不要采用这种设计框架了。
    </li>
</ul>
<h3>
    更进一步
</h3>
<p>
    有了上面的思路，已经可以动手开发了，但是我们应该可以更有追求一点。
</p>
<p>
    考虑一下，当如下需求产生时，我们应该如何应对？
</p>
<ul>
    <li>
        实时参照的 Lookup 看上去的确不错，我有很多应用都想这么做
    </li>
    <li>
        Lookup 的字段，和需要复制的字段中，有一些想看原始数据，另一些则想看最新数据
    </li>
</ul>
<p>
    我们发现这些需求是那种从特殊定制运用到广泛适用的那种情况，这时候就想到，plugin 不正是 kintone 为了解决通用性开发问题而提供的开发模式吗？在这里用插件是再合适不过了。
</p>
<p class="operaCheck">
    开发插件必定要产生更多的准备工作和更多的代码规模，如果您只是想实现单一功能，可以从之后的代码逻辑舍去插件相关部分，可以大大缩短开发进程。
</p>
<h2>
    开发过程
</h2>
<p>
    现在我们已经明确了要做一个什么样的东西，下面应该就可以进入到正式开发的环节了。
</p>
<p>
    俗话说，万事开头难。由于本次开发中，运用到的技术相对较多，如果一开始没有规划好的话，很难保证后面的开发能顺利进行。所以这里有必要对开发前的准备，做一番说明。
</p>
<h3>
    开发准备
</h3>
<p>
    开发准备中，我把内容分为三个方面，可行性验证，开发环境，和 kintone App。
</p>
<h4>
    可行性验证
</h4>
<p>
    在正式开发之前，我们还需要确认一下本次开发的功能是可以实现的，几个最关键的节点，逻辑是可以连通的。如果事先不进行验证的话，可能开发到一半才发现功能实现不了，就像空中楼阁是注定建不成的。
</p>
<p>
    1. 根据【事务表】中的 Lookup 字段，找到【主表】中的参照字段。说简单点就是寻找 Lookup 的目标。经过一定的研究发现，在 REST API中并没有提供相应的信息，你获取的 Lookup 中，只回有当前的值，而不会有参照的目标。但是这点根本难不倒我们，因为我们发现，网页上 Lookup 是能链接到参照的那条记录的(类似 /k/88/show#record=1 这样的形式)，所以根据超链接地址，我们便可拿到想要的 Record ID。
</p>
<h4>
    开发环境
</h4>
<p>
    由于本次的开发内容还是略有点复杂的，所以一个纯 js 文件一镜到底的模式是万万不可取的。我默认读者已经具有搭建 npm 包管理项目经验，之后所有的叙述也是基于这个基础之上。如果您对这方面不是很了解的话，可以参看之前发布的<a href="/hc/kb/section/1198566/"> 环境搭建的系列文章</a>。
</p>
<p>
    下面我会讲一下本次开发中运用到的技术，以及为什么会这样选择的缘由。
</p>
<p>
    <b>插件</b>。&nbsp;&nbsp;在接下来的开发过程介绍中，我会以插件开发为例来讲述。所以如果有读者对插件开发不熟悉的话，可以先看参这两篇文章：<a href="/hc/kb/article/1000576/"> 插件开发的准备</a>，<a href="/hc/kb/section/1/"> 插件开发流程</a>。
</p>
<p>
    <b>Vue</b>。&nbsp;&nbsp;因为涉及到插件开发，在配置页面，必定会产生画面的制作，并且会产生前后台的数据交换逻辑。这时候我们采用前端框架制作画面上的一部分元素，会是一个不错的选择。当然这里选择 React 也是很推荐的。有需求的读者自行替换即可。
</p>
<p>
    <b>TypeScript</b>。&nbsp;&nbsp;对于本项目要不要上 TypeScript，我也是有所犹豫。因为 TypeScript 向来争议比较大，虽然在提高代码质量方面十分优秀，但是也带来了开发难度直线上升的问题。这里最后还是选择迎难而上，一方会面的原因是，开发中会遇到 API 获取 App 配置的部分，这部分的数据的结构有点复杂，把类型定义清晰之后，可以避免一些处理数据时的失误，并把主要精力放在逻辑上，而不是数据类型比对上。另一方面，开发者网站本应主打开拓引导，提供先例等方面的宗旨，况且之前虽然推出过 TypeScript 介绍的文章，但是还没有实际开发的案例文章，所以本文就斗胆做一次尝试。希望对将来有意向运用 TypeScript 进行开发的个人或团队提供一些参考。
</p>
<p>
    运用 TypeScript 肯定会产生一些前期配置工作，幸好之前我们有过几篇文章的介绍，有需要的读者可以参考一下。
</p>
<ul>
    <li>
        <a href="/hc/kb/article/1465343/">向JavaScript自定义中级开发者的目标前进（5）〜TypeScript导入篇〜</a>
    </li>
    <li>
        <a href="/hc/kb/article/1427187/">使用TypeScript开发kintone自定义</a>
    </li>
    <li>
        <a href="/hc/kb/article/1436364/">TypeScript+React for kintone开发模版</a>
    </li>
    <li>
        <a href="/hc/kb/article/1447813/">Webpack5+vscode搭建kintone开发环境（九）支持 Typescript</a>
    </li>
</ul>
<p>
    <b>环境小结：</b>开发环境的搭建，在项目建立的初期是比较花时间的。但是一个好的环境对项目的帮助也是非常之大，可以节省后期很多时间。当然上面说的这些技术也不是必须引入的，开发者可以根据实际情况，酌情考虑，或弃用或寻找替代品都是可以的。
</p>

<h4>
    kintone App
</h4>
<p>
    这次我们还是用之前讲到的案件管理项目来作为范例。主表我们采用kintone商城里自带的【客户信息】应用。
</p>

<img style="width:800px" src="https://s3.bmp.ovh/imgs/2023/06/02/aec8e15ec8f3eec8.png" alt="">

<p>
    而事务表我们选择自行创建，因为演示并不需要太多的字段。这里简单地加几个字段。
</p>
<img style="width:800px" src="https://s3.bmp.ovh/imgs/2023/06/02/a497f540320a6c38.png" alt="">

<p>
    这里的【对方客户】字段设置成 Lookup 类型，用来引用【客户信息】应用中的信息。而【客户电话】字段，是复制【客户信息】中的电话，但需要显示最新电话，而不是创建时的电话。
</p>